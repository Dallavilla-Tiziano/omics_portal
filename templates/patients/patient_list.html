{% extends '_base.html' %}
{% load render_table from django_tables2 %}

{% block title %}Patients{% endblock title %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row">

    <!-- Left Sidebar (Filters) -->
    <div class="col-lg-2">
        <div class="card shadow-sm">
            <div class="card-header text-white">
                Filters
            </div>
            <div class="card-body">
                <form method="get"
                      hx-get="{% url 'patient_list' %}"
                      hx-target="#table-container"
                      hx-trigger="change delay:500ms"
                      hx-params="*"
                      id="filter-form">
                    {{ filter.form.as_p }}
                    <button type="button" class="btn btn-secondary mt-3"
                        onclick="document.getElementById('filter-form').reset(); htmx.trigger('#filter-form', 'change');">
                        Reset Filters
                    </button>
                </form>
            </div>
        </div>
    </div>
    <!-- Middle Section (Table) -->
    <div class="col-lg-8">
        <div id="table-container">
            {% render_table table %}
        </div>
    </div>

    <!-- Right Sidebar (Display Settings) -->
    <div class="col-lg-2 d-flex flex-column">
        <!-- Right Sidebar (Display Settings) -->
        <div class="card shadow-sm mb-3">
            <div class="card-header text-white">
                Table Display Settings
            </div>
            <div class="card-body">
                <label for="rows">Rows per page:</label>
                <select name="rows" id="rows" class="form-select"
                        hx-get="{% url 'patient_list' %}"
                        hx-target="#table-container"
                        hx-trigger="change"
                        hx-params="*">
                    <option value="10">10</option>
                    <option value="20" selected>20</option>
                    <option value="25">50</option>
                    <option value="50">100</option>
                </select>
            </div>
        </div>

        <!-- Export Cohort Box -->
        <div class="card shadow-sm mt-3">
            <div class="card-header text-white">
                Export cohort
            </div>
            <div class="card-body">
                <a id="download-link" href="{% url 'patient_list_csv' %}" class="btn btn-primary">Download CSV</a>
            </div>
        </div>
    </div>
  </div>
</div>

<!-- JavaScript to Update Download Link with Filters -->
<script>
    document.addEventListener("htmx:afterRequest", function() {
        let downloadLink = document.getElementById("download-link");
        let params = new URLSearchParams(new FormData(document.getElementById("filter-form")));
        downloadLink.href = "{% url 'patient_list_csv' %}?" + params.toString();
    });
</script>
{% endblock content %}